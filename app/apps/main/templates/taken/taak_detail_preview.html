{% extends "base.html" %}
{% load webpack_static from webpack_loader %}
{% load multiply previous next from list_tags %}
{% load taakopdracht render_onderwerp get_bijlagen from melding_tags %}
{% load to_date replace_comma_by_dot vind_in_dict from main_tags %}
{% load json_encode from main_tags %}
{% load mor_core_url mor_core_protected_url from main_tags %}
{% load context_template from context_tags %}
{% load get_gebruiker_object_middels_email get_taakgebeurtenis_voor_taakstatus from gebruikers_tags %}

{% block title %}
    {% with melding=taak.melding.response_json %}
    {% with locatie=melding.locaties_voor_melding.0 %}
    Taak: {{ taak.titel }}, {{ locatie.straatnaam|lower|capfirst }}{% if locatie.huisnummer %} {{ locatie.huisnummer }}{% endif %}
    {% endwith %}
    {% endwith %}
{% endblock %}

{% block extra_head %}
{% if gebruiker_email %}
{% with melding=taak.melding.response_json %}
{% with locatie=melding.locaties_voor_melding.0 %}
<meta property="og:title" content="Taak: {{ taak.titel }}, {{ locatie.straatnaam|lower|capfirst }}{% if locatie.huisnummer %} {{ locatie.huisnummer }}{% endif %}" />
<meta property="og:type" content="website" />
<meta property="og:url" content="{{ ABSOLUTE_ROOT }}{% url 'taak_detail_preview' taak.id signed_data %}" />
<meta property="og:description" content="Deze link is gedeeld door: {{gebruiker_email}}" />

{% get_bijlagen melding as bijlagen %}
{% if bijlagen %}
<meta property="og:image" content="{{ ABSOLUTE_ROOT }}{{ bijlagen.0.afbeelding_relative_url|mor_core_url:signed_data }}" />
<meta property="og:image:width" content="600" />
<meta property="og:image:height" content="600" />
{% endif %}

{% endwith %}
{% endwith %}
{% endif %}
{% endblock %}

{% block pageheader %}
{% endblock pageheader %}

{% block body %}
<turbo-frame id="taak_basis">
{% if not gebruiker_email %}
<p>Deze link is verlopen.<br><a href="{% url 'taak_detail' taak.id %}" data-turbo-action="replace">Terug naar de taak</a></p>
{% else %}
    {% with melding=taak.melding.response_json %}
    {% with locatie=melding.locaties_voor_melding.0 %}
    {% with geometrie=locatie.geometrie %}
    <div>
        <div data-controller="detail"
             data-detail-taak-object-value="{{ taak }}"
             data-detail-incident-y-value="{{ geometrie.coordinates.0|replace_comma_by_dot }}"
             data-detail-incident-x-value="{{ geometrie.coordinates.1|replace_comma_by_dot }}"
             data-detail-mercure-public-url-value="{{ APP_MERCURE_PUBLIC_URL }}"
             {% if not DEBUG %}data-detail-mercure-subscriber-token-value="{{ MERCURE_SUBSCRIBER_TOKEN }}"{% endif %}
             {% if taak.magAfhandelen %}class="has-sticky-footer"{% endif %}>
            <div class="taak-detail">
                <div class="container__header-taaknavigatie">
                    <br><a href="{% url 'taak_detail' taak.id %}" data-turbo-action="replace">Naar orginele taak</a>
                    <br><p>Deze link is gedeeld door '{{ gebruiker_email }}'</p><br>
                    <h1 class="h3">
                        {{ locatie.straatnaam|lower|capfirst }}
                        {% if locatie.huisnummer %}{{ locatie.huisnummer }}{% endif %}
                        <span class="badge {% if taak.taakstatus.naam == 'nieuw' %}badge--darkblue {% elif taak.taakstatus.naam == 'toegewezen' %}badge--yellow {% else %}badge--green{% endif %}">{{ taak.taakstatus.naam|lower|capfirst }}
                            {% if taak.additionele_informatie.uitvoerder %}aan {{ taak.additionele_informatie.uitvoerder }}{% endif %}
                        </span>
                    </h1>

                    <div class="container__flex">
                        <div>
                            <span>{{ taak.titel }}</span>
                            <br>
                            <span class="lighter">
                                <span data-detail-target="taakAfstand"
                                      data-latitude="{{ geometrie.coordinates.1|replace_comma_by_dot }}"
                                      data-longitude="{{ geometrie.coordinates.0|replace_comma_by_dot }}"></span> meter afstand
                            </span>
                        </div>
                        <div class="textalign--right">
                            {% if device_os == "ios" %}
                                <small>
                                    <a class="link"
                                       href="http://maps.apple.com/?saddr=''&daddr={{ geometrie.coordinates.1|replace_comma_by_dot }},{{ geometrie.coordinates.0|replace_comma_by_dot }}&z=10&"
                                       target="_top"
                                       aria-label="Navigeer naar taak"
                                       data-detail-target="navigeerLink">
                                        {% include "icons/navigate.svg" %}
                                        Navigeren
                                    </a>
                                </small>
                            {% else %}
                                <a class="link"
                                   data-action="detail#makeRoute"
                                   data-detail-lat-param="{{ geometrie.coordinates.1|replace_comma_by_dot }}"
                                   data-detail-long-param="{{ geometrie.coordinates.0|replace_comma_by_dot }}"
                                   target="_top"
                                   aria-label="Navigeer naar taak">
                                    {% include "icons/navigate.svg" %}
                                    Navigeren
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% get_bijlagen melding as bijlagen %}
                <section class="section--seperated"
                        data-testid="detailPhotoviewer"
                        {% if bijlagen|length < 2 %}style="border: 0;"{% endif %}
                    >
                    <div class="full-width">
                        {% if bijlagen %}
                            <div class="container__imageslider"
                                 data-detail-target="imageSliderContainer"
                                 data-action="scroll->detail#onScrollSlider">
                                <ul class="list-clean imageslider"
                                    style="width: calc(100% * {{ bijlagen|length }})">
                                    {% for foto in bijlagen %}
                                        <li class="container__image"
                                            id="{{ foto.afbeelding_relative_url|mor_core_url:signed_data }}">
                                            <img src="{{ foto.afbeelding_relative_url|mor_core_url:signed_data }}"
                                                 alt=""
                                                 data-detail-target="selectedImage"
                                                 {% comment %}
                                                 data-action="click->detail#openImageInPopup"
                                                 {% endcomment %} />
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% if bijlagen|length > 1 %}
                                <div class="container__thumbs">
                                    <ul data-detail-target="thumbList">
                                        {% for foto in bijlagen %}
                                            <li data-action="click->detail#selectImage"
                                                data-detail-image-index-param="{{ forloop.counter }}">
                                                <div class="container__image">
                                                    <img src="{{ foto.afbeelding_verkleind_relative_url|mor_core_url:signed_data }}"
                                                         alt="" />
                                                </div>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="no-image" style="background-image: url('{% webpack_static 'icons/noimage.svg' %}')">
                            </div>
                        {% endif %}
                    </div>
                </section>
                <section data-testid="detailTaak">
                    <div class="container__details taak">
                        <div class="container__map full-width">
                            <div class="map map--single"
                                    id="incidentMap"
                                    data-action="touchstart->detail#onTwoFingerDrag touchend->detail#onTwoFingerDrag">
                                <div class="map__overlay">
                                    <span>Gebruik twee vingers om de kaart te verplaatsen</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
{% endwith %}
{% endwith %}
{% endwith %}
{% endif %}
</turbo-frame>
{% endblock body %}
