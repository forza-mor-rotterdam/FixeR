{% extends 'snippets/modal_context.html' %}
{% load l10n %}
{% load webpack_static from webpack_loader %}
{% load to_date vind_in_dict to_timestamp from main_tags %}
{% load json_encode replace_comma_by_dot adres_order_nummer from main_tags %}
{% load context_template from context_tags %}
{% with incident_id=incident.id|stringformat:"s" %}

{% block before_modal_content %}

    <div
        data-incidentlist-target="taakItem"
        data-id="{{ taak.id }}"
        data-onderwerpen="{{ taak.render_onderwerpen }}"
        data-adres="{{ taak.adres }}"
        data-geometrie="{{ taak.geometrie|json_encode }}"
        data-afbeelding-url="{{ taak.afbeelding_url }}"
        data-order-datum="{{ taak.aangemaakt_op|to_date|to_timestamp }}"
        data-order-adres="{{ taak|adres_order_nummer:taken_sorted_by_adres }}"
        data-order-afstand="0"
        data-order-postcode="{{ taak.postcode_digits }}"
        class="list-item{% if form_submitted %} form-is-submitted{% endif %}{% if errors and warnings %} has-errors{% endif %}"
        {% if TEMPLATE_BASIS != "benc" and not taak.afgesloten_op %}
            data-controller="taak"
            data-action="formHandleIsConnected->taak#formHandleIsConnectedHandler cancelHandle->taak#cancelHandleHandler"
            data-taak-date-value="{{ incident.datumMelding }}"
            data-taak-days-value="{{ incident.werkdagenSindsRegistratie }}"
        {%endif%}>
        {% if TEMPLATE_BASIS != "benc" and not taak.afgesloten_op %}
        <button
            class="container__actions handle--no-success"
            data-id="{{ incident.id }}"
        >
            <div>
                <span>Niet opgelost</span>
            </div>
        </button>
        <button
            class="container__actions handle--success"
            data-id="{{ incident.id }}"
        >
            <div>
                <span>Afhandelen</span>
            </div>
        </button>
        {% endif %}
        <div class="wrapper__swipe">
            <div class="container__flex">
                <a href="{% url 'taak_detail' taak.id %}" data-turbo-frame="taak_basis" aria-label="Bekijk taak {{ taak.id }}">
                    <div class="container__image">

                        {% if taak.melding.response_json.bijlagen %}
                        {% with taak.melding.response_json.bijlagen|first as first_foto %}
                        <div class="background-image" style="background-image: url('{{ first_foto.afbeelding_verkleind_relative_url }}')"></div>
                        {% endwith %}
                        {% else %}
                            <div class="background-image" style="background-image: url('{% webpack_static 'icons/noimage.svg' %}'); background-size: 40%;"></div>
                        {% endif %}
                    </div>

                    <div class="container__info">
                        {% context_template "taak_lijst_item_titel.html" as title_template %}
                        {% include title_template %}
                        <div class="incident__moment">
                            <span data-taak-target="incidentDate">
                                {% localize on %}
                                {% if taak.taakstatus.naam != "nieuw" %}{{ taak.taakstatus.naam }}: {% endif %}{{ taak.taakstatus.aangemaakt_op|to_date|date:"D d M Y"|lower }} {{ taak.taakstatus.aangemaakt_op|to_date|time:"H:i" }}<br>
                                {% endlocalize %}
                            </span>
                        </div>
                        <div class="incident__distance">
                            {% with taak.melding.response_json.locaties_voor_melding.0.geometrie.coordinates as geo %}
                            <span><span data-incidentlist-target="taakAfstand"  data-latitude="{{geo.1|replace_comma_by_dot}}" data-longitude="{{geo.0|replace_comma_by_dot}}" ></span> meter</span>
                            {% endwith %}
                        </div>
                    </div>
                </a>
                <button class="btn btn-icon--clean" data-incidentlist-taak-id-param="{{ taak.id }}" data-filter-code-param="" data-action="incidentlist#selectTaakMarker" aria-label="Bekijk op kaart">
                    <svg class="map" width="19" height="18" viewBox="0 0 19 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M16.8125 2.65479V13.9394L11.75 15.205L7.25 14.08L2.1875 15.3457V4.06104L7.25 2.79541L11.75 3.92041L16.8125 2.65479ZM11.1875 4.93941L7.8125 4.09566V13.061L11.1875 13.9048V4.93941ZM12.3125 13.9048L15.6875 13.061V4.09566L12.3125 4.93941V13.9048ZM6.6875 13.061V4.09566L3.3125 4.93941V13.9048L6.6875 13.061Z" fill="white"></path>
                    </svg>
                </button>
            </div>
        </div>
{% endblock %}

{% block modal_header %}
<h1>
    <span>Taak behandelen</span><br>
    <small>{{ taak.titel }}</small>
</h1>
<button
    type="button"
    class="btn-close"
    aria-label="Sluit"
    data-action="taak#closeModal"
></button>
{% endblock %}

{% block modal_body %}
<turbo-frame
    id="incident_modal_handle_{{ taak.id }}"
    data-taak-target="turboFormHandler"
    data-src="{% url 'incident_modal_handle_part' taak.id %}"
>
</turbo-frame>
{% endblock %}

{% block after_modal_content %}
    </div>
{% endblock %}
{% endwith %}
